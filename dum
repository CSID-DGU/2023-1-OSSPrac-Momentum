pipeline {
    agent any  

		triggers {
				pollSCM('*/3 * * * *') //3분주기로 변경사항을 체크
		} 

    environment { // jenkins가 dockerhub에 접근할 수 있도록 환경변수 등록
        DOCKER = credentials('docker-hub')
    } 

    stages {
	//레포지토리 다운받음
        stage('Prepare') {
						agent any 
	
            steps {
               
											
                git url :'https://github.com/CSID-DGU/2023-1-OSSPrac-Momentum-2',
                    branch : 'main',
                    credentialsId: 'github'
                
            }
            post {
                success{ //pull 성공
                    echo 'Successfully cloned Repository'
                }
                always{ 
                    echo "i tried..."
                }
                cleanup{ //post에 있는 작업까지 다 끝냄
                    echo "after all other post condition"
                }
            }
        }


        stage('Build') { // docker compose 
            steps {
                dir('/var/jenkins_home/workspace/hw6@2') {
                   
                    sh "docker-compose build hw6"
                    
                }
                
            }
        }

        stage('Tag') { // 이미지 태깅
            steps {
                script {
                    sh "docker tag ${DOCKER_USR}/momentum ${DOCKER_USR}/momentum:${BUILD_NUMBER}"
                }
            }
        }

        stage('Push') { // docker hub에 push 
            steps {
                script {
                    sh "docker login -u ${DOCKER_USR} -p ${DOCKER_PSW}"
                    sh "docker push ${DOCKER_USR}/ossp_week9:${BUILD_NUMBER}"
                }
            }
        }

        
    }
}
	